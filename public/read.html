<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reader</title>
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    header { padding: .6rem .8rem; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: .6rem; }
    header a { text-decoration: none; color: #2563eb; }
    #title { font-weight: 600; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    #stage { height: calc(100% - 49px); }
    #pdfFrame { width: 100%; height: 100%; border: 0; }
    #epubStage { width: 100%; height: 100%; overflow: hidden; }
  </style>
  <!-- epub.js (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/epubjs@0.3/dist/epub.min.js"></script>
</head>
<body>
  <header>
    <a href="/" aria-label="Back">← Library</a>
    <div id="title">Loading…</div>
  </header>

  <div id="stage">
    <iframe id="pdfFrame" class="hidden"></iframe>
    <div id="epubStage" class="hidden"></div>
  </div>

  <script>
    function qs(k){ return new URL(location.href).searchParams.get(k); }
    function show(el){ el.classList.remove('hidden'); }
    function hide(el){ el.classList.add('hidden'); }

    async function getBooks(){
      const r = await fetch('/api/books', { credentials: 'include' });
      if (!r.ok) throw new Error('not authed or failed');
      return (await r.json()).items || [];
    }

    async function main(){
      const id = qs('id');
      if(!id){ document.getElementById('title').textContent = 'Missing id'; return; }

      let item;
      try {
        const items = await getBooks();
        item = items.find(x => x.id === id);
      } catch(e){
        // ignore, we can still try to open the file directly
      }

      const title = item?.title || '(untitled)';
      const type  = (item?.type || '').toLowerCase();
      document.getElementById('title').textContent = title;

      const fileURL = `/api/file?id=${encodeURIComponent(id)}`;

      if (type === 'pdf') {
        // Let the browser PDF viewer display it
        const frame = document.getElementById('pdfFrame');
        frame.src = fileURL;
        show(frame);
      } else if (type === 'epub') {
        // Render EPUB via epub.js
        const stage = document.getElementById('epubStage');
        show(stage);
        const book = ePub(fileURL);
        const rendition = book.renderTo('epubStage', { width: '100%', height: '100%' });
        await rendition.display();
      } else {
        // Unknown type — just navigate to the file so browser downloads/opens it.
        location.href = fileURL;
      }
    }

    // tiny helper so we can toggle classes without tailwind
    (function(){
      const s = document.createElement('style');
      s.textContent = '.hidden{display:none}';
      document.head.appendChild(s);
    })();

    main();
  </script>
</body>
</html>
