<!DOCTYPE html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Your Library</title>
<style>
  body{font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; margin:24px; color:#111}
  h1{margin:0 0 16px}
  .card{border:1px solid #e7e7e7; border-radius:12px; padding:16px; max-width:980px}
  .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  input,button{font:inherit}
  button{cursor:pointer; padding:.55rem .9rem; border-radius:10px; border:1px solid #ccc; background:#f7f7f7}
  button:hover{background:#eee}
  .list{margin-top:18px}
  .item{padding:12px 8px; border-bottom:1px solid #eee; display:flex; gap:12px; align-items:center}
  .meta{flex:1 1 auto}
  .title{font-weight:600}
  .author{color:#666}
  .progress{min-width:120px; color:#444}
  .danger{border-color:#e78; background:#fde}
  .muted{color:#666}
  .hidden{display:none}
</style>

<h1>Your Library</h1>
<div class="card">
  <div id="loginSection">
    <p><strong>Sign in</strong></p>
    <div class="row">
      <input id="email" placeholder="you@example.com" style="padding:.5rem .7rem; border-radius:10px; border:1px solid #ccc; min-width:260px" />
      <button id="btnSend">Send magic link</button>
    </div>
    <p id="loginMsg" class="muted"></p>
  </div>

  <div id="appSection" class="hidden">
    <div class="row" style="margin-bottom:12px">
      <span>Signed in as <strong id="who">…</strong></span>
      <input id="file" type="file" multiple />
      <button id="btnUpload">Upload</button>
      <button id="btnRefresh">Refresh Library</button>
      <button id="btnOut">Sign out</button>
    </div>
    <div id="list" class="list"></div>
  </div>
</div>

<script>
async function me(){
  try{ const r=await fetch('/api/me',{credentials:'include'}); const j=await r.json(); return j.user||null }catch{ return null }
}
function fmtPct(p){ if(p==null) return '—'; return Math.round((p||0)*100)+'%' }
function el(tag, attrs={}, ...kids){
  const n=document.createElement(tag); for(const k in attrs){
    if(k==='class') n.className=attrs[k]; else if(k==='html') n.innerHTML=attrs[k]; else n.setAttribute(k, attrs[k])
  }
  for(const k of kids){ if(typeof k==='string') n.appendChild(document.createTextNode(k)); else if(k) n.appendChild(k) }
  return n
}
async function refresh(){
  const r=await fetch('/api/books',{credentials:'include'})
  const j=await r.json(); const list=document.getElementById('list'); list.innerHTML=''
  for(const b of (j.books||[])){
    const title = b.title || 'Untitled'
    const author = b.author || ''
    const row = el('div',{class:'item'},
      el('div',{class:'meta'},
        el('div',{class:'title'}, `${title}`),
        el('div',{class:'author'}, author ? `— ${author}` : '')
      ),
      el('div',{class:'progress'}, fmtPct(b.percent)),
      el('button',{class:'danger', onclick:async (e)=>{
        if(!confirm('Remove this book?')) return
        await fetch(`/api/books/${encodeURIComponent(b.id)}`, {method:'DELETE', credentials:'include'})
        refresh()
      }}, 'Remove'),
    )
    row.addEventListener('click', (ev)=>{
      if(ev.target.tagName==='BUTTON') return
      location.href = `/viewer.html?book=${encodeURIComponent(b.id)}`
    })
    list.appendChild(row)
  }
}
async function upload(){
  const fi=document.getElementById('file')
  if(!fi.files || !fi.files.length) return alert('Pick files first')
  const fd = new FormData()
  Array.from(fi.files).forEach(f => fd.append('files', f, f.name))
  const r=await fetch('/api/upload', {method:'POST', body:fd, credentials:'include'})
  if(!r.ok){ alert(await r.text()); return }
  await refresh()
  fi.value=''
}

(async function init(){
  const user = await me()
  if(!user){
    document.getElementById('loginSection').classList.remove('hidden')
    document.getElementById('appSection').classList.add('hidden')
  }else{
    document.getElementById('loginSection').classList.add('hidden')
    document.getElementById('appSection').classList.remove('hidden')
    document.getElementById('who').textContent = user.email
    refresh()
  }

  // login
  document.getElementById('btnSend').addEventListener('click', async ()=>{
    const email = (document.getElementById('email').value||'').trim()
    if(!email) return
    const msg = document.getElementById('loginMsg'); msg.textContent = 'Sending…'
    const r = await fetch('/api/auth/request-link', {method:'POST', headers:{'content-type':'application/json'}, body:JSON.stringify({email})})
    const j = await r.json().catch(()=>({}))
    if(j && j.link){
      // open the exchange in a new tab to set the cookie, then come back
      window.open(j.link, '_blank', 'noopener')
      msg.innerHTML = `Magic link opened in a new tab. <a href="${j.link}">Click here</a> if it didn’t.`
    }else{
      msg.textContent = 'Could not send link.'
    }
  })

  // out
  document.getElementById('btnOut').addEventListener('click', async ()=>{
    await fetch('/api/auth/signout', {method:'POST', credentials:'include'})
    location.reload()
  })
  document.getElementById('btnUpload').addEventListener('click', upload)
  document.getElementById('btnRefresh').addEventListener('click', refresh)
})();
</script>
