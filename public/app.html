<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Your Library · Reader</title>
<style>
  :root{--fg:#111;--muted:#666;--line:#eee;--bg:#fff}
  *{box-sizing:border-box}
  body{font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:var(--bg);color:var(--fg)}
  header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);padding:12px 16px;display:flex;gap:12px;align-items:center;z-index:10}
  h1{font-size:16px;margin:0;font-weight:700;flex:1}
  main{padding:16px}
  .toolbar{display:flex;gap:8px;align-items:center}
  .btn{border:1px solid #ddd;background:#fafafa;padding:7px 12px;border-radius:8px;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  input[type="file"]{display:none}
  .hint{color:var(--muted);margin:16px 0}
  .dropzone{border:2px dashed var(--line);border-radius:10px;padding:24px;text-align:center;color:var(--muted)}
  ul{list-style:none;margin:16px 0 0;padding:0;display:grid;gap:10px}
  li{display:flex;align-items:center;gap:10px;padding:10px;border:1px solid var(--line);border-radius:10px}
  a.book{flex:1 1 auto;text-decoration:none;color:inherit;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .meta{color:var(--muted);font-size:12px;margin-left:8px}
  .quiet{color:var(--muted);font-size:12px}
</style>
</head>
<body>
<header>
  <h1>Your Library</h1>
  <div class="toolbar">
    <label class="btn" for="fileInput">Upload</label>
    <input id="fileInput" type="file" multiple accept=".epub,.pdf"/>
    <button id="signout" class="btn" title="Sign out">Sign out</button>
  </div>
</header>

<main>
  <div id="emptyState" class="hint" style="display:none">No books yet.</div>
  <div id="dz" class="dropzone">Drop EPUB/PDF files here or use the <b>Upload</b> button</div>
  <ul id="list"></ul>
</main>

<script>
(async function(){
  const listEl = document.getElementById('list');
  const emptyEl = document.getElementById('emptyState');
  const dz = document.getElementById('dz');

  // ---------- helpers ----------
  const fetchJSON = (url, opts={}) =>
    fetch(url, {credentials:'include', ...opts}).then(r => {
      if (!r.ok) throw new Error(`${r.status}`);
      return r.json();
    });

  // Title label: prefer DB author; otherwise split only the FIRST separator
  // (supports -, –, —, and --) and ignore extra segments (publisher, source, etc.)
  function labelFor(b){
    const titleRaw = (b.title && b.title.trim())
      || (b.r2_key ? b.r2_key.split('/').pop().replace(/\.[^.]+$/,'') : b.id);
    let title = titleRaw;
    let author = (b.author && b.author.trim()) || '';
    if (!author && /\s[-–—]{1,2}\s/.test(title)) {
      const parts = title.split(/\s[-–—]{1,2}\s/);
      if (parts.length >= 2){
        title = parts[0].trim();
        author = parts[1].trim(); // only the second chunk; drop the rest
      }
    }
    return author ? `${title} – ${author}` : title;
  }

  async function load(){
    listEl.innerHTML = '';
    let items = [];
    try {
      const data = await fetchJSON('/api/library');
      items = data.items || [];
    } catch (e) {
      listEl.innerHTML = `<li class="quiet">Failed to load library (${e.message}).</li>`;
      return;
    }
    emptyEl.style.display = items.length ? 'none' : 'block';

    for (const b of items){
      const li = document.createElement('li');

      const a = document.createElement('a');
      a.className = 'book';
      a.href = `/viewer.html?book=${encodeURIComponent(b.id)}`;
      a.textContent = labelFor(b);

      const meta = document.createElement('span');
      meta.className = 'meta';
      meta.textContent = b.type ? b.type.toUpperCase() : '';

      const remove = document.createElement('button');
      remove.className = 'btn';
      remove.textContent = 'Remove';
      remove.addEventListener('click', async ()=>{
        remove.disabled = true;
        try {
          const r = await fetch(`/api/books/${encodeURIComponent(b.id)}`, {method:'DELETE', credentials:'include'});
          if (!r.ok) throw new Error('delete failed');
          li.remove();
          if (!listEl.children.length) emptyEl.style.display = 'block';
        } catch {
          alert('Failed to remove');
        } finally {
          remove.disabled = false;
        }
      });

      li.appendChild(a);
      li.appendChild(meta);
      li.appendChild(remove);
      listEl.appendChild(li);
    }
  }

  // ---------- upload ----------
  async function uploadFile(file){
    const fd = new FormData();
    fd.append('file', file, file.name);
    const r = await fetch('/api/upload', { method:'POST', body: fd, credentials:'include' });
    if (!r.ok) throw new Error(`upload ${file.name} failed (${r.status})`);
    return r.json();
  }

  document.getElementById('fileInput').addEventListener('change', async (e)=>{
    const files = Array.from(e.target.files || []);
    if (!files.length) return;
    dz.textContent = 'Uploading...';
    try {
      for (const f of files) await uploadFile(f);
    } catch (err) {
      alert(err.message || 'Upload failed');
    }
    dz.textContent = 'Drop EPUB/PDF files here or use the Upload button';
    e.target.value = '';
    load();
  });

  // drag & drop
  ;['dragenter','dragover'].forEach(ev => dz.addEventListener(ev, e => { e.preventDefault(); dz.style.borderColor = '#bbb'; }));
  ;['dragleave','drop'].forEach(ev => dz.addEventListener(ev, e => { e.preventDefault(); dz.style.borderColor = '#eee'; }));
  dz.addEventListener('drop', async (e)=>{
    const files = Array.from(e.dataTransfer.files || []).filter(f => /epub|pdf/i.test(f.type) || /\.(epub|pdf)$/i.test(f.name));
    if (!files.length) return;
    dz.textContent = 'Uploading...';
    try {
      for (const f of files) await uploadFile(f);
    } catch (err) {
      alert(err.message || 'Upload failed');
    }
    dz.textContent = 'Drop EPUB/PDF files here or use the Upload button';
    load();
  });

  // sign out
  document.getElementById('signout').addEventListener('click', async ()=>{
    await fetch('/api/auth/signout', {method:'POST', credentials:'include'}).catch(()=>{});
    location.href = '/';
  });

  // initial load
  load();
})();
</script>
</body>
</html>
