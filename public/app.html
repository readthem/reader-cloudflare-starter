<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Library · Reader</title>
<style>
  body{font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:#fff;color:#111}
  header{position:sticky;top:0;background:#fff;border-bottom:1px solid #eee;padding:12px 16px;display:flex;gap:12px;align-items:center}
  h1{font-size:16px;margin:0;font-weight:700}
  main{padding:16px}
  ul{list-style:none;margin:0;padding:0;display:grid;gap:10px}
  li{display:flex;align-items:center;gap:10px;padding:10px;border:1px solid #eee;border-radius:10px}
  a.book{flex:1 1 auto;text-decoration:none;color:inherit;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .meta{color:#666;font-size:12px;margin-left:8px}
  button{border:1px solid #ddd;background:#fafafa;padding:6px 10px;border-radius:8px;cursor:pointer}
  button:hover{background:#f3f3f3}
  #empty{color:#666}
</style>
</head>
<body>
<header>
  <h1>Your Library</h1>
  <span id="who" style="margin-left:auto;color:#666"></span>
  <button id="signout">Sign out</button>
</header>

<main>
  <p id="empty" style="display:none">No books yet.</p>
  <ul id="list"></ul>
</main>

<script>
(async function init(){
  // require session
  const me = await fetch('/api/me', {credentials:'include'});
  if(me.status===401){ location.href = '/'; return; }
  try{ const j=await me.json(); document.getElementById('who').textContent=j.email||''; }catch{}

  const listEl = document.getElementById('list');
  const emptyEl = document.getElementById('empty');

  async function load(){
    listEl.innerHTML='';
    const r = await fetch('/api/books', {credentials:'include'});
    if(!r.ok){ emptyEl.textContent='Failed to load library.'; emptyEl.style.display=''; return; }
    const items = await r.json(); // [{id,title,author,percent,r2_key}]
    if(!items.length){ emptyEl.style.display=''; return; }
    emptyEl.style.display='none';

    for(const b of items){
      const li = document.createElement('li');

      const title = (b.title && b.title.trim()) || (b.r2_key ? b.r2_key.split('/').pop().replace(/\.[^.]+$/,'') : b.id);
      const author = b.author && b.author.trim();
      const label = author ? `${title} – ${author}` : title;

      const a = document.createElement('a');
      a.className='book';
      a.href = `/viewer.html?book=${encodeURIComponent(b.id)}`;
      a.textContent = label;

      const meta = document.createElement('span');
      meta.className='meta';
      if(typeof b.percent === 'number') meta.textContent = `(${Math.round(b.percent*100)}%)`;

      const del = document.createElement('button');
      del.className='remove';
      del.textContent='Remove';
      del.dataset.id = b.id;

      // Click handlers
      del.addEventListener('click', async (e)=>{
        e.preventDefault(); e.stopPropagation();
        const id = e.currentTarget.dataset.id;
        if(!id) return;
        try{
          const rr = await fetch(`/api/books/${encodeURIComponent(id)}`, {method:'DELETE', credentials:'include'});
          if(rr.ok) load(); else alert('Failed to remove.');
        }catch{ alert('Failed to remove.'); }
      });

      li.appendChild(a);
      li.appendChild(meta);
      li.appendChild(del);
      listEl.appendChild(li);
    }
  }

  document.getElementById('signout').addEventListener('click', async ()=>{
    await fetch('/api/auth/signout', {method:'POST', credentials:'include'}).catch(()=>{});
    location.href='/';
  });

  load();
})();
</script>
</body>
</html>
