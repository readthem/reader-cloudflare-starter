<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reader Cloudflare Starter</title>
  <style>
    :root { --b:#e5e7eb; --r:12px; --pad:1rem; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 2rem; }
    .card { border: 1px solid var(--b); border-radius: var(--r); padding: var(--pad); margin: 1rem 0; }
    .row { display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; }
    .hidden { display: none; }
    button { padding: .6rem 1rem; border-radius: 10px; border: 1px solid var(--b); cursor: pointer; }
    input[type="email"], input[type="file"] { padding: .6rem; border: 1px solid var(--b); border-radius: 8px; }
    ul { list-style: none; padding: 0; }
    li { padding: .35rem 0; }
    code { background: #f6f7f9; padding: .2rem .4rem; border-radius: 6px; }
  </style>
</head>
<body>
  <h1>Reader Cloudflare Starter</h1>

  <section id="loginCard" class="card">
    <h3>Login</h3>
    <div class="row">
      <input id="email" type="email" placeholder="you@example.com" />
      <button id="btnSend">Send magic link</button>
    </div>
    <p id="loginMsg"></p>
  </section>

  <section id="appCard" class="card hidden">
    <div class="row">
      <div>Signed in as <strong id="who"></strong></div>
      <button id="btnRefresh">Refresh Library</button>
      <button id="btnSignOut">Sign out</button>
    </div>

    <div class="row">
      <input id="file" type="file" multiple />
      <button id="btnUpload">Upload</button>
    </div>
    <p id="uploadMsg"></p>

    <h3>Your Library</h3>
    <ul id="library"></ul>
  </section>

<script>
/* ---------- helpers ---------- */
async function getMe() {
  try {
    const r = await fetch('/api/me', { credentials:'include' });
    if (!r.ok) return null;
    const t = await r.text();
    try { const j = JSON.parse(t); return j.user || j; } catch { return null; }
  } catch { return null; }
}
async function sendMagicLink(){
  const email = document.getElementById('email').value.trim();
  if (!email) return;
  const msg = document.getElementById('loginMsg');
  msg.textContent = 'Sending…';
  try{
    const r = await fetch('/api/auth/request-link', {
      method:'POST',
      headers:{'content-type':'application/json'},
      credentials:'include',
      body: JSON.stringify({ email })
    });
    const raw = await r.text();
    let link; try { link = JSON.parse(raw).link; } catch {}
    if (!link) {
      const m = raw.match(/https?:\/\/[^"']+\/api\/auth\/exchange\?t=[^"'\s<>]+/i);
      if (m) link = m[0];
    }
    if (link) {
      await fetch(link, { redirect:'manual', credentials:'include' });
      await init();
    } else {
      msg.textContent = 'Server did not return a link.'; console.log('RAW:', raw);
    }
  }catch(e){ msg.textContent = `Could not send email: ${e.message}`; }
}
async function signOut(){ try{ await fetch('/api/auth/signout',{method:'POST',credentials:'include'});}catch{} location.reload(); }

async function refreshLibrary() {
  const ul = document.getElementById('library');
  ul.textContent = 'Loading…';
  try {
    const r = await fetch('/api/books', { credentials:'include' });
    const text = await r.text();
    if (!r.ok) throw new Error(text || r.status);
    let data; try { data = JSON.parse(text); } catch { throw new Error(text); }

    const items = data.items || data.books || data || [];
    ul.textContent = '';
    if (!items.length) { ul.textContent = 'No books yet. Upload an EPUB or PDF.'; return; }
    for (const b of items) {
      const li = document.createElement('li');
      const title = b.title || b.id;
      const kind = (b.type || '').toUpperCase();
      li.textContent = `${title}${kind ? ' • ' + kind : ''}`;
      ul.appendChild(li);
    }
  } catch (e) {
    ul.textContent = `Could not load library: ${e.message}`;
  }
}

function inferExtFromType(t){ t=(t||'').toLowerCase(); if(t.includes('pdf'))return'pdf'; if(t.includes('epub'))return'epub'; return null; }

async function uploadSelected() {
  const input = document.getElementById('file');
  const btn = document.getElementById('btnUpload');
  const msg = document.getElementById('uploadMsg');
  if (!input.files || !input.files.length) { alert('Pick a file first'); return; }

  btn.disabled = true; btn.textContent = 'Uploading…'; msg.textContent = '';
  try {
    for (const f of input.files) {
      const fd = new FormData();
      fd.append('files', f, f.name);
      const r = await fetch('/api/upload', { method:'POST', body: fd, credentials:'include' });
      const t = await r.text();
      if (!r.ok) throw new Error(t || `${r.status} Upload failed`);
    }
    msg.textContent = 'Upload complete.';
    await refreshLibrary();
  } catch (e) {
    console.error(e);
    msg.textContent = `Upload failed: ${e.message}`;
  } finally {
    btn.disabled = false; btn.textContent = 'Upload';
  }
}

/* ---------- boot ---------- */
async function init(){
  const me = await getMe();
  const loginCard = document.getElementById('loginCard');
  const appCard   = document.getElementById('appCard');
  if (me && me.email) {
    loginCard.classList.add('hidden');
    appCard.classList.remove('hidden');
    document.getElementById('who').textContent = me.email;
    await refreshLibrary();
  } else {
    appCard.classList.add('hidden');
    loginCard.classList.remove('hidden');
  }
}
document.getElementById('btnSend')?.addEventListener('click', sendMagicLink);
document.getElementById('btnUpload')?.addEventListener('click', uploadSelected);
document.getElementById('btnRefresh')?.addEventListener('click', refreshLibrary);
document.getElementById('btnSignOut')?.addEventListener('click', signOut);
init();
</script>
</body>
</html>
