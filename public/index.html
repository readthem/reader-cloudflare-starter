<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sign in · Reader</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; }
    .wrap { max-width: 720px; margin: 10vh auto; padding: 2rem; }
    .card { background: canvas; border: 1px solid color-mix(in oklab, CanvasText 12%, Canvas 88%); border-radius: 16px; padding: 2rem; box-shadow: 0 20px 60px rgba(0,0,0,.06); }
    h1 { margin: 0 0 1rem; font-size: clamp(1.6rem, 2vw + 1rem, 2.2rem); }
    p.hint { margin: 0 0 1.25rem; color: color-mix(in oklab, CanvasText 55%, Canvas 45%); }
    .field { display: flex; flex-direction: column; gap: .5rem; }
    input[type="email"] {
      width: 100%; padding: .95rem 1rem; font-size: 1.05rem;
      border: 1px solid color-mix(in oklab, CanvasText 15%, Canvas 85%);
      border-radius: 12px; background: Field; color: FieldText;
    }
    .row { margin-top: 1rem; display: flex; gap: .75rem; align-items: center; }
    button {
      appearance: none; border: 1px solid color-mix(in oklab, CanvasText 12%, Canvas 88%);
      padding: .95rem 1.2rem; border-radius: 12px; font-weight: 600; cursor: pointer; width: 100%;
      background: color-mix(in oklab, AccentColor 16%, Canvas 84%);
    }
    button[disabled] { opacity: .6; cursor: default; }
    #msg { margin-top: 1rem; min-height: 1.25rem; }
    a { color: AccentColor; }
  </style>
</head>
<body>
  <main class="wrap">
    <section class="card">
      <h1>Sign in</h1>
      <p class="hint">Use your email to receive a magic link.</p>

      <div class="field">
        <input id="email" type="email" autocomplete="email" placeholder="you@example.com" required />
      </div>
      <div class="row">
        <button id="btnSend" type="button">Send magic link</button>
      </div>
      <div id="msg" aria-live="polite"></div>
    </section>
  </main>

  <script>
  // Absolute safety net: block any accidental form submit on the page
  addEventListener('submit', e => { e.preventDefault(); e.stopPropagation(); });

  (function () {
    const $ = s => document.querySelector(s);
    const emailEl = $('#email');
    const btn = $('#btnSend');
    const msg = $('#msg');

    // If this logs on click, JS is wired; if the page still reloads, a different page is being served
    btn.addEventListener('click', async (ev) => {
      ev.preventDefault();
      ev.stopPropagation();
      console.log('[login] click caught');

      const email = (emailEl.value || '').trim();
      if (!email) { emailEl.focus(); return; }

      btn.disabled = true;
      msg.textContent = 'Sending…';

      let raw;
      try {
        const r = await fetch('/api/auth/request-link', {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify({ email })
        });
        raw = await r.text();
      } catch (e) {
        btn.disabled = false;
        msg.textContent = 'Could not contact server.';
        console.error(e);
        return;
      }

      // Parse {link} or scrape the exchange URL from an HTML error page
      let link = null;
      try { link = JSON.parse(raw).link; } catch {}
      if (!link) {
        const m = raw && raw.match(/https?:\/\/[^"'<>\s]+\/api\/auth\/exchange\?t=[^"'<>\s]+/i);
        if (m) link = m[0];
      }

      if (!link) {
        btn.disabled = false;
        msg.textContent = 'Server did not return a link.';
        console.warn('RAW:', raw);
        return;
      }

      // Try silent cookie set
      try {
        await fetch(link, { redirect: 'manual', credentials: 'include' });
        const me = await fetch('/api/me', { credentials: 'include' }).then(r => r.ok ? r.json() : null);
        if (me && me.user) {
          msg.textContent = 'Signed in. Redirecting…';
          location.replace('/app.html'); // change if your dashboard is elsewhere
          return;
        }
      } catch {}

      // Fallback: manual link
      msg.innerHTML = 'Could not set cookie automatically. Finish sign-in here: '
        + `<a href="${link}" rel="noopener noreferrer">exchange</a>`;
      btn.disabled = false;
    });

    // Support Enter
    emailEl.addEventListener('keydown', e => {
      if (e.key === 'Enter') { e.preventDefault(); e.stopPropagation(); btn.click(); }
    });
  })();
  </script>
</body>
</html>
