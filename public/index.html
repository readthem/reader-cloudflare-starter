<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reader Cloudflare Starter</title>
  <style>
    :root { --b:#e5e7eb; --r12:12px; --pad:.7rem; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 2rem; }
    .card { border: 1px solid var(--b); border-radius: var(--r12); padding: var(--pad); margin: 1rem 0; }
    .row { display: flex; gap: 1rem; align-items: center; }
    .hidden { display: none; }
    button { padding: .6rem 1rem; border-radius: 10px; border: 1px solid var(--b); cursor: pointer; }
    input[type="email"], input[type="file"] { padding: .6rem; border: 1px solid var(--b); border-radius: 8px; }
    ul { list-style: none; padding: 0; }
    li { padding: .35rem 0; }
    a.book { text-decoration: none; }
    a.book:hover { text-decoration: underline; }
    code { background: #f6f7f9; padding: .2rem .4rem; border-radius: 6px; }
  </style>
</head>
<body>
  <h1>Reader Cloudflare Starter</h1>

  <!-- Login -->
  <section id="loginCard" class="card">
    <h3>Login</h3>
    <div class="row">
      <input id="email" type="email" placeholder="you@example.com" />
      <button id="btnSend">Send magic link</button>
    </div>
    <p id="loginMsg"></p>
  </section>

  <!-- App -->
  <section id="appCard" class="card hidden">
    <div class="row">
      <div>Signed in as <strong id="who"></strong></div>
      <button id="btnRefresh">Refresh Library</button>
      <button id="btnSignOut">Sign out</button>
    </div>
    <div class="row">
      <input id="file" type="file" multiple />
      <button id="btnUpload">Upload</button>
    </div>
    <p id="uploadMsg"></p>

    <h3>Your Library</h3>
    <ul id="library"></ul>
  </section>

<script>
/* ---------------- helpers ---------------- */
function escapeHtml(s){ return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
async function getMe(){
  const r = await fetch('/api/me', { credentials:'include' });
  if (!r.ok) return null;
  const t = await r.text();
  try { return JSON.parse(t); } catch { return null; }
}
function renderLibrary(items){
  const ul = document.getElementById('library');
  ul.textContent = '';
  for (const b of items){
    const li = document.createElement('li');
    const a = document.createElement('a');
    a.className = 'book';
    a.textContent = (b.title || '(untitled)') + ' • ' + (String(b.type || '').toUpperCase() || '?');
    a.href = `/api/books/open?id=${encodeURIComponent(b.id)}`;
    a.target = '_blank';
    a.rel = 'noopener';
    li.appendChild(a);
    ul.appendChild(li);
  }
}
function shorten(s, n=140){ s = String(s||''); return s.length>n ? s.slice(0,n)+'…' : s; }

/* --------------- UI actions --------------- */
async function refreshLibrary(){
  const msg = document.getElementById('uploadMsg');
  msg.textContent = 'Loading...';
  try{
    const r = await fetch('/api/books', { credentials:'include' });
    const data = await r.json();
    renderLibrary(data.items || []);
    msg.textContent = '';
  }catch(e){
    msg.textContent = 'Could not load library: ' + e.message;
  }
}

async function upload(){
  const fileInput = document.getElementById('file');
  const files = Array.from(fileInput.files || []);
  const msg = document.getElementById('uploadMsg');
  if (!files.length) { msg.textContent = 'Pick a file first.'; return; }

  msg.textContent = 'Uploading...';
  try{
    for (const f of files){
      const fd = new FormData();
      fd.append('files', f, f.name);
      const r = await fetch('/api/upload', { method:'POST', body: fd, credentials:'include' });
      if (!r.ok) throw new Error(await r.text());
    }
    msg.textContent = 'Upload complete.';
    await refreshLibrary();
  }catch(e){
    console.error(e);
    msg.textContent = 'Upload failed: ' + (e?.message || e);
  }finally{
    fileInput.value = '';
  }
}

async function signOut(){
  await fetch('/api/auth/signout', { method:'POST', credentials:'include' }).catch(()=>{});
  location.reload();
}

/* -------- robust magic-link flow (no hanging) -------- */
async function sendMagicLink(){
  const email = document.getElementById('email')?.value?.trim();
  const msg = document.getElementById('loginMsg');
  const btn = document.getElementById('btnSend');
  if (!email) { msg.textContent = 'Enter an email.'; return; }

  btn.disabled = true;
  msg.textContent = 'Sending…';

  try{
    // Timeout guard so we never hang
    const ac = new AbortController();
    const timer = setTimeout(() => ac.abort(), 15000); // 15s

    const r1 = await fetch('/api/auth/request-link', {
      method:'POST',
      headers:{'content-type':'application/json'},
      credentials:'include',
      body: JSON.stringify({ email }),
      signal: ac.signal
    });
    clearTimeout(timer);

    const raw = await r1.text();
    if (!r1.ok) {
      console.log('request-link raw:', raw);
      msg.textContent = `Server error ${r1.status}. ${shorten(raw)}`;
      btn.disabled = false;
      return;
    }

    // Try JSON first
    let link = null;
    try { link = JSON.parse(raw).link; } catch {}
    // Fallback: try to find it inside HTML
    if (!link) {
      const m = raw.match(/https?:\/\/[^"']+\/api\/auth\/exchange\?t=[^"'\s<>]+/i);
      link = m && m[0];
    }

    if (!link) {
      msg.textContent = 'Server did not return a link.';
      console.log('RAW:', raw);
      btn.disabled = false;
      return;
    }

    // Exchange the token -> set cookie
    const r2 = await fetch(link, { redirect:'manual', credentials:'include' });
    // Some setups return 0 on manual redirect; that's fine.

    // Verify session
    const me = await getMe();
    if (me && me.email) {
      msg.textContent = 'Signed in.';
      await init(); // will show app & library
      return;
    } else {
      msg.innerHTML =
        'Could not sign in (cookie not set). '+
        'You can also click this link manually: '+
        `<a href="${link}" rel="noopener">exchange</a>`;
      btn.disabled = false;
      return;
    }
  } catch(e){
    msg.textContent = (e && e.name === 'AbortError')
      ? 'Timed out contacting the server.'
      : 'Could not send email: ' + (e?.message || e);
    btn.disabled = false;
  }
}

/* ---------------- boot ---------------- */
async function init(){
  const me = await getMe();
  const loginCard = document.getElementById('loginCard');
  const appCard   = document.getElementById('appCard');

  if (me && me.email){
    document.getElementById('who').textContent = me.email;
    loginCard.classList.add('hidden');
    appCard.classList.remove('hidden');
    await refreshLibrary();
  } else {
    appCard.classList.add('hidden');
    loginCard.classList.remove('hidden');
  }
}

document.getElementById('btnUpload').addEventListener('click', upload);
document.getElementById('btnRefresh').addEventListener('click', refreshLibrary);
document.getElementById('btnSignOut').addEventListener('click', signOut);
document.getElementById('btnSend').addEventListener('click', sendMagicLink);

init();
</script>
</body>
</html>
