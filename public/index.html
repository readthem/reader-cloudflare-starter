<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sign in · Reader</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; }
    .wrap { max-width: 720px; margin: 10vh auto; padding: 2rem; }
    .card { background: canvas; border: 1px solid color-mix(in oklab, CanvasText 12%, Canvas 88%); border-radius: 16px; padding: 2rem; box-shadow: 0 20px 60px rgba(0,0,0,.06); }
    h1 { margin: 0 0 1rem; font-size: clamp(1.6rem, 2vw + 1rem, 2.2rem); }
    p.hint { margin: 0 0 1.25rem; color: color-mix(in oklab, CanvasText 55%, Canvas 45%); }
    .field { display: flex; flex-direction: column; gap: .5rem; }
    input[type="email"] {
      width: 100%; padding: .95rem 1rem; font-size: 1.05rem;
      border: 1px solid color-mix(in oklab, CanvasText 15%, Canvas 85%);
      border-radius: 12px; background: Field; color: FieldText;
    }
    .row { margin-top: 1rem; display: flex; gap: .75rem; align-items: center; }
    button {
      appearance: none; border: 1px solid color-mix(in oklab, CanvasText 12%, Canvas 88%);
      padding: .95rem 1.2rem; border-radius: 12px; font-weight: 600; cursor: pointer; width: 100%;
      background: color-mix(in oklab, AccentColor 16%, Canvas 84%); color: color-contrast(CanvasText vs Canvas);
    }
    button[disabled] { opacity: .6; cursor: default; }
    #msg { margin-top: 1rem; min-height: 1.25rem; }
    a { color: AccentColor; }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  </style>
</head>
<body>
  <main class="wrap">
    <section class="card">
      <h1>Sign in</h1>
      <p class="hint">Use your email to receive a magic link.</p>

      <!-- We keep the form for accessibility, but prevent its default submit. -->
      <form id="loginForm" novalidate>
        <div class="field">
          <input id="email" type="email" autocomplete="email" placeholder="you@example.com" required />
        </div>
        <div class="row">
          <button id="btnSend" type="button">Send magic link</button>
        </div>
        <div id="msg" aria-live="polite"></div>
      </form>
    </section>
  </main>

<script>
(function () {
  const $ = sel => document.querySelector(sel);
  const emailEl = $('#email');
  const btn = $('#btnSend');
  const msg = $('#msg');
  const form = $('#loginForm');

  // prevent implicit form submit refresh
  form.addEventListener('submit', (e) => e.preventDefault());
  btn.addEventListener('click', (e) => { e.preventDefault(); sendMagicLink(); });

  async function sendMagicLink() {
    const email = (emailEl.value || '').trim();
    if (!email) { emailEl.focus(); return; }

    btn.disabled = true;
    msg.textContent = 'Sending…';

    let res, raw;
    try {
      res = await fetch('/api/auth/request-link', {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify({ email })
      });
      raw = await res.text();
    } catch (err) {
      btn.disabled = false;
      msg.textContent = 'Could not contact server.';
      console.error('request-link failed', err);
      return;
    }

    // Try JSON first
    let link = null;
    try { link = JSON.parse(raw).link; } catch {}

    // Fallback: find an exchange URL inside HTML error body
    if (!link) {
      const m = raw && raw.match(/https?:\/\/[^"'<>\s]+\/api\/auth\/exchange\?t=[^"'<>\s]+/i);
      if (m) link = m[0];
    }

    if (!link) {
      btn.disabled = false;
      msg.innerHTML = 'Could not send magic link.<br><small><code>' + escapeHtml(raw?.slice(0,400) || 'no response') + '</code></small>';
      console.warn('RAW request-link body:', raw);
      return;
    }

    // Try to exchange without opening a new tab
    try {
      const r2 = await fetch(link, { redirect: 'manual', credentials: 'include' });
      // If the Worker set a cookie, /api/me will return the user
      const me = await fetch('/api/me', { credentials: 'include' }).then(r => r.ok ? r.json() : null).catch(() => null);
      if (me && me.user) {
        msg.textContent = 'Signed in. Redirecting…';
        // Go to your app/library page
        location.replace('/app.html'); // change to '/' if your library is at root
        return;
      }
    } catch (e) {
      // ignore and fall through to manual link
    }

    // As a last resort, let the user click the exchange link manually.
    msg.innerHTML = 'Could not set a cookie automatically. '
      + 'You can complete sign-in here: '
      + '<a href="' + link + '" rel="noopener noreferrer">exchange</a>';
    btn.disabled = false;
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }
})();
</script>
</body>
</html>
