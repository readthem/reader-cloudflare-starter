<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reader Cloudflare Starter</title>
  <style>
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,sans-serif; margin: 2rem; }
    .card { border:1px solid #e5e7eb; border-radius:12px; padding:1rem; margin:1rem 0; }
    .row { display:flex; gap:1rem; align-items:center; flex-wrap:wrap; }
    button,input[type="email"],input[type="file"] { padding:.6rem .9rem; border:1px solid #e5e7eb; border-radius:10px; }
    ul { list-style:none; padding:0; }
    li { padding:.45rem 0; }
    a { color:inherit; text-decoration:underline; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <h1>Reader Cloudflare Starter</h1>

  <section id="loginCard" class="card">
    <h3>Login</h3>
    <div class="row">
      <input id="email" type="email" placeholder="you@example.com" />
      <button id="btnSend">Send magic link</button>
    </div>
    <p id="loginMsg"></p>
  </section>

  <section id="appCard" class="card hidden">
    <div class="row">
      <div>Signed in as <strong id="who"></strong></div>
      <button id="btnRefresh">Refresh Library</button>
      <button id="btnSignOut">Sign out</button>
    </div>
    <div class="row">
      <input id="file" type="file" multiple />
      <button id="btnUpload">Upload</button>
      <span id="uploadMsg"></span>
    </div>
    <h3>Your Library</h3>
    <ul id="library"></ul>
  </section>

<script>
const $ = sel => document.querySelector(sel);

async function getMe(){
  try { const r = await fetch('/api/me', { credentials:'include' });
        if (!r.ok) return null;
        const t = await r.text(); return JSON.parse(t).user || null;
  } catch { return null; }
}

async function sendMagicLink(){
  const email = $('#email').value.trim();
  if (!email) return;
  const msg = $('#loginMsg'); msg.textContent = 'Sending...';
  try{
    const r = await fetch('/api/auth/request-link', {
      method:'POST',
      headers:{'content-type':'application/json'},
      body: JSON.stringify({ email })
    });
    const raw = await r.text();
    let link; try { link = JSON.parse(raw).link; } catch{};
    if (!link) link = (raw.match(/https?:\/\/[^"']+\/api\/auth\/exchange\?t=[^"'\s<>]+/i)||[])[0];

    if (!link) { msg.textContent = 'Server did not return a link.'; return; }

    // Try to set cookie via fetch (no redirect follow)
    const ex = await fetch(link, { redirect:'manual', credentials:'include' });
    if (ex.status === 0 || (ex.status >= 200 && ex.status < 400)) {
      msg.textContent = 'Signed in.';
      await init(); return;
    }
    msg.textContent = 'Could not sign in (cookie not set). You can also click this link manually: ';
    const a = document.createElement('a'); a.href = link; a.textContent = 'exchange'; msg.appendChild(a);
  }catch(e){
    msg.textContent = 'Could not send email.';
  }
}

async function fetchBooks(){
  const r = await fetch('/api/books', { credentials:'include' });
  if (!r.ok) throw new Error('Load failed');
  return (await r.json()).books || [];
}

function renderBooks(books){
  const ul = $('#library'); ul.innerHTML = '';
  books.forEach(b => {
    const li = document.createElement('li');
    const a = document.createElement('a');
    a.href = `/viewer.html?id=${encodeURIComponent(b.id)}&type=${encodeURIComponent(b.type||'epub')}`;
    a.textContent = b.author ? `${b.title} â€” ${b.author}` : b.title;
    li.appendChild(a); ul.appendChild(li);
  });
}

async function upload(){
  const files = $('#file').files;
  const msg = $('#uploadMsg');
  if (!files || !files.length) return;
  msg.textContent = 'Uploading...';
  try{
    const fd = new FormData();
    for (const f of files) fd.append('files', f);
    const r = await fetch('/api/upload', { method:'POST', body: fd, credentials:'include' });
    if (!r.ok) throw new Error(await r.text());
    msg.textContent = 'Upload complete.'; await refresh();
  }catch(e){ msg.textContent = 'Upload failed: ' + e.message; }
}

async function refresh(){
  const books = await fetchBooks();
  renderBooks(books);
}

async function init(){
  const me = await getMe();
  if (!me) {
    $('#appCard').classList.add('hidden');
    $('#loginCard').classList.remove('hidden');
  } else {
    $('#who').textContent = me.email || me.id;
    $('#loginCard').classList.add('hidden');
    $('#appCard').classList.remove('hidden');
    await refresh();
  }
}

$('#btnSend').addEventListener('click', sendMagicLink);
$('#btnRefresh').addEventListener('click', refresh);
$('#btnUpload').addEventListener('click', upload);
$('#btnSignOut').addEventListener('click', async () => { await fetch('/api/auth/signout', { method:'POST' }); location.reload(); });

init();
</script>
</body>
</html>
